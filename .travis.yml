language: node_js

node_js:
  - 8

sudo: required

services:
  - docker

branches:
  only:
  - master

env:
  - OC_SERVER: daily-stable10-qa
  - OC_SERVER: daily-master-qa

before_install:
  - wget -qO- http://download.owncloud.org/community/owncloud-$OC_SERVER.tar.bz2 | tar xj
  - DOCKER_ID=$(docker run -d -p 8888:8080 -e OWNCLOUD_DOMAIN=localhost -e OWNCLOUD_DB_TYPE=sqlite -e OWNCLOUD_ADMIN_USERNAME=admin -e OWNCLOUD_ADMIN_PASSWORD=admin --volume $(pwd)/owncloud:/var/www/owncloud owncloud/base:latest)

  - # needed else occ isn't available directly...
  - sleep 5

  - docker inspect $DOCKER_ID
  - docker exec $DOCKER_ID occ config:system:set cors.allowed-domains 0 --value http://127.0.0.1:9876
  - docker exec $DOCKER_ID occ config:system:set cors.allowed-domains 1 --value http://localhost:9876

script:
  - npm run lint
  - sleep 10
  - make test

after_script:
  - codecov
  - docker logs $DOCKER_ID
